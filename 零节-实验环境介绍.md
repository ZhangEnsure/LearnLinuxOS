# 进行操作系统实验前的准备工作

## 实验流程：
1. 实验的基本流程是根据实验要求编写应用程序、修改 Linux 0.11 的源代码，用 gcc 编译后，在 Bochs 的虚拟环境中运行、调试目标代码。
---
## 实验工具
1. Bochs 是一个免费且开放源代码的 IA-32（x86）架构 PC 机模拟器。在它模拟出的环境中可以运行 Linux、DOS 和各种版本的 Windows 等多种操作系统。而 Bochs 本身具有很高的移植性，可以运行在多种软硬件平台之上，这也是我们选择它做为本书的指定模拟器的主要原因。
2. GCC 是和 Linux 一起成长起来的编译器。Linux 最初的版本就是由 GCC 编译的。现在 GCC 也是在自由软件领域应用最广泛的编译器。所以，我们也选择 GCC 做为本书实验的指定编译器。
3. GDB 调试器是 GCC 编译器的兄弟。做为自由软件领域几乎是唯一的调试器，它秉承了 Unix 类操作系统的一贯风格，采用纯命令行操作，有点儿类似 dos 下的 debug。
---
## 实验文件
1. hit-oslab-linux-20110823.tar.gz
---
### 文件结构
1. Image文件
- oslab 工作在一个宿主操作系统之上，我们使用的 Linux，在宿主操作系统之上完成对 Linux 0.11 的开发、修改和编译之后，在 linux-0.11 目录下会生产一个名为 Image 的文件，它就是编译之后的目标文件。
> oslab 采用 bochs 模拟器加载这个 Image 文件，模拟执行 Linux 0.11，这样省却了重新启动计算机的麻烦。
2. bochs 目录
- bochs 目录下是与 bochs 相关的执行文件、数据文件和配置文件。
3. run 脚本
- 运行后 bochs 会自动在它的虚拟软驱 A 和虚拟硬盘上各挂载一个镜像文件，软驱上挂载是 linux-0.11/Image，硬盘上挂载的是 hdc-0.11.img。
- 因为 bochs 配置文件中的设置是从软驱 A 启动，所以 Linux 0.11 会被自动加载。
- 而 Linux 0.11 会驱动硬盘，并 mount 硬盘上的文件系统，也就是将 hdc-0.11.img 内镜像的文件系统挂载到 0.11 系统内的根目录 —— /。在 0.11 下访问文件系统，访问的就是 hdc-0.11.img 文件内虚拟的文件系统。
4. hdc-0.11.img 文件
- hdc-0.11.img 文件的格式是 Minix 文件系统的镜像。
- Linux 所有版本都支持这种格式的文件系统，所以可以直接在宿主 Linux 上通过 mount 命令访问此文件内的文件，达到宿主系统和 bochs 内运行的 Linux 0.11 之间交换文件的效果。
---
## 编译内核
1. 首先要进入 linux-0.11 目录，然后执行 make 命令：
```
$ cd ./linux-0.11/
$ make all
```因为 all 是最常用的参数，所以可以省略，只用 make，效果一样。
2. 最后生成的目标文件是一个软盘镜像文件—— linux-0.11/Image（下面的图中给出了详细的信息）。如果将此镜像文件写到一张 1.44MB 的软盘上，就可以启动一台真正的计算机。
3. make 命令会自动跳过未被修改的文件，链接时直接使用上次编译生成的目标文件，从而节约编译时间。但如果重新编译后，你的修改貌似没有生效，可以试试先 make clean ，再 make all（或者一行命令：make clean && make all。make clean 是删除上一次编译生成的所有中间文件和目标文件，确保是在全新的状态下编译整个工程。
---
## 运行内核
1. 在 Bochs 中运行最新编译好的内核很简单，在 oslab 目录下执行：
```
# 注意是在上层目录
# 刚刚编译是在 oslab/linux-0.11/ 文件夹下
$ cd ~/oslab/

# 执行 run 脚本
$ ./run
```
如果出现 Bochs 的窗口，里面显示 linux 的引导过程，最后停止在 [/usr/root/]#，表示运行成功。
---
## 调试
1. 分类：汇编级调试和 C 语言级调试。
2. 汇编级调试需要执行命令：
```
# 确认在 oslab 目录下
$ cd ~/oslab/

# 运行脚本前确定已经关闭刚刚运行的 Bochs
$ ./dbg-asm
```
汇编级调试的启动之后 Bochs 是黑屏，这是正常的。可以用命令 help 来查看调试系统用的基本命令。更详细的信息请查阅 Bochs 使用手册。
3. C 语言级调试稍微复杂一些。首先执行如下命令：
```
$ cd ~/oslab
$ ./dbg-c
然后再打开一个终端窗口，执行：
$ cd ~/oslab
$ ./rungdb
```
注意：启动的顺序不能交换，否则 gdb 无法连接。
---
## 文件交换
1. Ubuntu 和 Linux 0.11 之间的文件交换如何启动。开始设置文件交换之前，务必关闭所有的 Bochs 进程。
2. oslab 下的 hdc-0.11-new.img 是 0.11 内核启动后的根文件系统镜像文件，相当于在 bochs 虚拟机里装载的硬盘。在 Ubuntu 上访问其内容的方法是：
```
$ cd ~/oslab/

# 启动挂载脚本
$ sudo ./mount-hdc
```
大家使用 sudo 时，password 是 shiyanlou，也有可能不会提示输入密码。之后，hdc 目录下就是和 0.11 内核一模一样的文件系统了，可以读写任何文件（可能有些文件要用 sudo 才能访问）。  
3. 下一步
```
# 进入挂载到 Ubuntu 上的目录
$ cd ~/oslab/hdc

# 查看内容
$ ls -al
读写完毕，不要忘了卸载这个文件系统：

$ cd ~/oslab/
# 卸载
$ sudo umount hdc
```
- 经过 sudo ./mount-hdc 这样处理以后，我们可以在 Ubuntu 的 hdc 目录下创建一个 xxx.c 文件，然后利用 Ubuntu 上的编辑工具（如 gedit 等）实现对 xxx.c 文件的编辑工作，在编辑保存以后。
- 执行 sudo umount hdc 后，再进入 Linux 0.11（即 run 启动 bochs 以后）就会看到这个 xxx.c（即如下图所示），这样就避免了在 Linux 0.11 上进行编辑 xxx.c 的麻烦，因为 Linux 0.11 作为一个很小的操作系统，其上的编辑工具只有 vi，使用起来非常不便。